<!DOCTYPE html><html lang="ja"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>YUMEBLOG | Terraformのインストールでやっていることを追う</title><link rel="stylesheet" href="/_astro/_slug_.CCgM0VDp.css"></head> <body class="py-8 sm:py-12 bg-gray-50"> <div class="max-w-4xl mx-auto px-8 sm:px-16"> <header class="text-center border-b border-gray-300 pb-4 mb-6"><h1 class="text-3xl font-bold text-gray-600">Yume Blog</h1></header>  <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();</script><script>(()=>{var A=Object.defineProperty;var g=(i,o,a)=>o in i?A(i,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[o]=a;var d=(i,o,a)=>g(i,typeof o!="symbol"?o+"":o,a);{let i={0:t=>m(t),1:t=>a(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(a(t)),5:t=>new Set(a(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t),11:t=>1/0*t},o=t=>{let[l,e]=t;return l in i?i[l](e):void 0},a=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([l,e])=>[l,o(e)]));class y extends HTMLElement{constructor(){super(...arguments);d(this,"Component");d(this,"hydrator");d(this,"hydrate",async()=>{var b;if(!this.hydrator||!this.isConnected)return;let e=(b=this.parentElement)==null?void 0:b.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let c=this.querySelectorAll("astro-slot"),n={},h=this.querySelectorAll("template[data-astro-template]");for(let r of h){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of c){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("name")||"default"]=r.innerHTML)}let p;try{p=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",v=this.getAttribute("component-export");throw v&&(s+=` (export ${v})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}let u;await this.hydrator(this)(this.Component,p,n,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});d(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),c.disconnect(),this.childrenConnectedCallback()},c=new MutationObserver(()=>{var n;((n=this.lastChild)==null?void 0:n.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});c.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}async start(){let e=JSON.parse(this.getAttribute("opts")),c=this.getAttribute("client");if(Astro[c]===void 0){window.addEventListener(`astro:${c}`,()=>this.start(),{once:!0});return}try{await Astro[c](async()=>{let n=this.getAttribute("renderer-url"),[h,{default:p}]=await Promise.all([import(this.getAttribute("component-url")),n?import(n):()=>()=>{}]),u=this.getAttribute("component-export")||"default";if(!u.includes("."))this.Component=h[u];else{this.Component=h;for(let f of u.split("."))this.Component=this.Component[f]}return this.hydrator=p,this.hydrate},e,this)}catch(n){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,n)}}attributeChangedCallback(){this.hydrate()}}d(y,"observedAttributes",["props"]),customElements.get("astro-island")||customElements.define("astro-island",y)}})();</script><astro-island uid="Z6efcI" prefix="r2" component-url="/_astro/TitleHeader.CwZwICnB.js" component-export="default" renderer-url="/_astro/client.DL-_0xdV.js" props="{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;12-de76a3.md&quot;],&quot;data&quot;:[0,{&quot;isDraft&quot;:[0,false],&quot;title&quot;:[0,&quot;Terraformのインストールでやっていることを追う&quot;],&quot;tags&quot;:[1,[[0,&quot;terraform&quot;],[0,&quot;ubuntu&quot;]]],&quot;publishDate&quot;:[3,&quot;2025-09-12T00:00:00.000Z&quot;]}],&quot;body&quot;:[0,&quot;Terraformのセットアップが必要になり、公式が紹介しているubuntuのインストール方法を見に行ったところ以下のコマンドが掲載されていた。\n\n```sh\nwget -O - https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg\necho \&quot;deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(grep -oP &#39;(?&lt;=UBUNTU_CODENAME=).*&#39; /etc/os-release || lsb_release -cs) main\&quot; | sudo tee /etc/apt/sources.list.d/hashicorp.list\nsudo apt update &amp;&amp; sudo apt install terraform\n```\n\nよく分かってないと思ったので、何をやっているのか追っていこうと思う。\n\n## コマンドの構成\n\n以下の3つのパイプラインに分かれているので、それぞれ順に見ていく。\n\n1つ目\n\n```sh\nwget -O - https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg\n```\n\n2つ目\n\n```sh\necho \&quot;deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(grep -oP &#39;(?&lt;=UBUNTU_CODENAME=).*&#39; /etc/os-release || lsb_release -cs) main\&quot; | sudo tee /etc/apt/sources.list.d/hashicorp.list\n```\n\n3つ目\n\n```sh\nsudo apt update &amp;&amp; sudo apt install terraform\n```\n\n### 1つ目のパイプライン\n\n```sh\nwget -O - https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg\n```\n\n`wget -O -` で指定したURLの内容を標準出力に出す。今回の場合は Hashicorp のGPGキー。\n\nGPGは[RFC 9580](https://www.rfc-editor.org/rfc/rfc9580)で提案されているOpenPGPの実装で、公開鍵暗号または対称暗号アルゴリズムによるディジタル署名、圧縮、キー管理を提供するもの。\n\nこのコマンドでは以下から始まるGPGキーが得られる。\n\n```txt\n-----BEGIN PGP PUBLIC KEY BLOCK-----\n\n```\n\n続いて `gpg` コマンド。\n\n`--dearmor` は入力されたASCIIのGPGキーをバイナリ形式に変換するオプションで、`-o` は結果の出力先。ここで指定されているのはubuntuでの標準的なキーリング置き場。\n\n以上、1つ目のパイプライン。図に表してみる。\n\n```mermaid\ngraph\nwget\nhasi[apt.releases.hashicorp.com/gpg]\nkey[GPGキー]\ngpg\nkeyrings[\&quot;/usr/share/keyrings/hashicorp-archive-keyring.gpg\&quot;]\n\nwget --1.GPGキー取得--&gt; hasi\nwget --2.標準出力--&gt; key\ngpg --3.バイナリ変換--&gt; key\ngpg --4.保存--&gt; keyrings\n```\n\n### 2つ目のパイプライン\n\n```sh\necho \&quot;deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(grep -oP &#39;(?&lt;=UBUNTU_CODENAME=).*&#39; /etc/os-release || lsb_release -cs) main\&quot; | sudo tee /etc/apt/sources.list.d/hashicorp.list\n```\n\nこのパイプラインでは、aptパッケージマネージャが参照する追加のパッケージソース設定を作成している。\n\n一般的な形式は以下\n\n```\ndeb [options] uri suite [component1] [component2] [...]\n```\n\n- deb: バイナリパッケージ\n- [options]: `arch=`, `signed-by=` 等のオプション\n- uri: リポジトリのURL\n- suite: ディストリビューション名\n- component: main, contrib, non-free等のセクション\n\n詳細は `man 5 sources.list` で確認可能。\n\n上記の形式を作るために `echo` を使っている。\n\n2つ目のパイプラインを図に表すと以下。\n\n```mermaid\ngraph\necho\ntee\nkeyrings[\&quot;/usr/share/keyrings/hashicorp-archive-keyring.gpg\&quot;]\nlist[\&quot;/etc/apt/sources.list.d/hashicorp.list\&quot;]\ndpkg[dpkg等]\nrecord[\&quot;deb [options] uri ...\&quot;]\n\necho --1.利用--&gt; keyrings\necho --1.利用--&gt; dpkg\necho --2.標準出力--&gt; record\ntee --3.利用--&gt; record\ntee --4.出力--&gt; list\n```\n\n### 3つ目のパイプライン\n\n```sh\nsudo apt update &amp;&amp; sudo apt install terraform\n```\n\nパッケージをアップデートして terraform をインストールしている...だけだと味気ないので深掘り。\n\nアップデートをする際、前のパイプラインで追加した `hashicorp.list` を見てパッケージ情報の入ったInReleaseファイルを取得する。\nこの中にはパッケージリストのハッシュ値とその署名が含まれているので、それをGPGキーで検証することで、情報が改竄されていないことを確認する。\n\nインストール時も実際のパッケージファイルに対して同様の検証を行っている模様。\n\n図にすると以下。\n\n```mermaid\ngraph\nupdate[apt update]\ninstall[apt install terraform]\nlist[パッケージリスト]\npackage[パッケージ]\nkey[hashicorp-archive-keyring.gpg]\n\nupdate --1.取得--&gt; list\nupdate --2.利用--&gt; key\nupdate --2.検証--&gt; list\ninstall --3.取得--&gt; package\ninstall --4.利用--&gt; key\ninstall --4.検証--&gt; package\n```\n\n## 感想\n\nパッケージマネージャ周りがよく分かっていないと思い知らされた。\n`apt update`, `apt install` 周りはまた調べることにする。&quot;],&quot;filePath&quot;:[0,&quot;src/content/blog/12-de76a3.md&quot;],&quot;digest&quot;:[0,&quot;28a78c9c9f337ff2&quot;],&quot;collection&quot;:[0,&quot;blog&quot;],&quot;slug&quot;:[0,&quot;12-de76a3&quot;],&quot;render&quot;:[0,null]}]}" ssr client="load" opts="{&quot;name&quot;:&quot;TitleHeader&quot;,&quot;value&quot;:true}" await-children><div class="grid grid-cols-1 sm:grid-cols-[1fr_auto] sm:gap-4 items-baseline"><div class="flex items-center gap-4 min-w-0"><div class="hidden sm:block"><button class="rounded-lg flex items-center text-gray-700 hover:text-gray-800 transition-colors duration-200 hover:bg-gray-100 p-1 group cursor-pointer"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="transition-all duration-200"><path d="M19 12H5M12 19L5 12L12 5" stroke-linecap="round" stroke-linejoin="round" fill="none"></path></svg></button></div><h2 class="text-2xl font-bold text-gray-700 min-w-0">Terraformのインストールでやっていることを追う</h2></div><div class="justify-self-end"><div class="flex gap-2"><span class="text-sm text-gray-500">公開日:</span><time class="text-sm text-gray-500">2025年9月12日</time></div></div></div><!--astro:end--></astro-island> <div class="mt-4 prose">  </div>  </div> </body></html>